set(NAME arm)

ReadVariables(${CMAKE_CURRENT_LIST_DIR}/Makefile "LDSCRIPT")
string(REPLACE "_FLASH.ld" "" DEVICE ${LDSCRIPT} )
string(LENGTH ${DEVICE} DEVICE_LENGTH)
math(EXPR DEVICE_LENGTH "${DEVICE_LENGTH} - 2")
string(SUBSTRING ${DEVICE} 0 ${DEVICE_LENGTH} DEVICE)

function(LOAD_DRIVERS)
	file(GLOB_RECURSE SOURCES
			*.c
            *.cpp
			*.h
            *.hpp
			*.s
			)
	add_library(Drivers INTERFACE)
	target_sources(Drivers INTERFACE "${SOURCES}")
endfunction()

LOAD_DRIVERS()

ReadVariables(${CMAKE_CURRENT_SOURCE_DIR}/Makefile "C_SOURCES")     # get C sources from makefile generated by CubeMX

set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -Wno-strict-prototypes")

file(GLOB_RECURSE allDriversFiles
		Drivers/*.c
		)

foreach(file ${allDriversFiles})
	set_source_files_properties(${file} PROPERTIES COMPILE_FLAGS "-w")
endforeach(file)

set_source_files_properties(Src/syscalls.c PROPERTIES COMPILE_FLAGS "-w")

file(GLOB_RECURSE SOURCES_AUTO
		Inc/*.h
		Src/*.c
		Src/*.cpp
		*.s
)

ReadVariables(${CMAKE_CURRENT_SOURCE_DIR}/Makefile "C_INCLUDES")

set(HAL_INCLUDES "")
foreach(incc ${C_INCLUDES})
	string(REPLACE "-I" "" incc ${incc})
	set(HAL_INCLUDES "${HAL_INCLUDES}; ${incc} ")
endforeach(incc)

include_directories(
		${HAL_INCLUDES}
)

set(SOURCES  ${SOURCES_AUTO} ${C_SOURCES} )

add_executable(${NAME} ${SOURCES})

set_target_properties(${NAME} PROPERTIES LINK_FLAGS "-T ${PLATFORM_LINKER_SCRIPT} -Xlinker -print-memory-usage -Wl,--gc-sections -specs=nano.specs -flto -lc -u _printf_float ${ARMFLOAT}")

target_link_libraries(${NAME}
		core
)

target_include_directories(${NAME} PUBLIC ${CMAKE_CURRENT_SOURCE_DIR}/../../core)

add_custom_command(TARGET ${NAME}
		POST_BUILD
		COMMAND ${CMAKE_OBJCOPY} -v -O ihex "${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/${NAME}" "${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/${NAME}.hex"
		COMMAND ${CMAKE_OBJCOPY} ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/${NAME} ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/${NAME}.elf)

target_jlink_flash(${NAME} 0x8000000)

target_stlink_flash(${NAME} stm32f3x.cfg)